# 7.2典型区块链技术

## 1、以太坊

以太坊（Ethereum）是一个支持智能合约的区块链平台，它与比特币最大的不同是，以太坊通过一个虚拟机（EVM）可以运行智能合约。

以太坊是[Vitalik Buterin](https://vitalik.ca/)（维塔利克·布特林，人称V神）在2013年提出的概念，Vitalik最早参与了比特币社区的开发，并希望比特币把功能受限的脚本扩展成<u>图灵完全的编程环境</u>，但没有得到比特币开发社区的认同，于是他决定另起炉灶，打造一个新的区块链平台，目标是<u>运行去中心化的程序。</u>

### 以太坊与比特币

相似点：和比特币类似，以太坊也通过PoW（工作量证明）进行挖矿。目前每个区块奖励是2 Ether。

不同点：

1. 以太坊平均出块时间更短（比特币10min，以太坊13~15s）
2. 以太坊区块更小
3. 以太坊含有智能合约和EVM虚拟机，实现智能合约和更多去中心化应用
4. 以太坊采用预挖矿机制（在发布运行前产生了7200W以太币用于众筹）
5. 货币发行总量不同（以太币每年产出相对固定数量，不超过100W以太币）
6. 以太坊中叔父区块也有奖励

### 以太坊核心架构

以太坊整体架构有三层：底层服务层、核心层、顶层应用。

有时采用五层架构，从下到上是：数据层、网络层、共识层、激励层、智能合约层。

<u>一般来说，区块链系统由数据层、网络层、共识层、激励层、合约层和应用层组成。</u>

> 激励机制不是所有区块链都有的，有些联盟链和私有链不存在激励机制（节点是指定的或是利益共同体组成，不需要激励）。

## 2、区块链组成

### 区块

区块是在区块链网络上承载交易数据的数据包，是一种被标记上时间戳和之前一个区块的哈希值的数据结构，区块经过网络的共识机制验证并确认区块中的交易。

区块主要由区块头、交易列表和叔区块头组成。

### 父块

父块是指区块的前一个区块，区块链通过在区块头记录区块以及父块的哈希值来在时间上排序。

### 区块头

记录当前区块的元信息，包含当前版本号、上一区块的哈希值、时间戳、随机数、Merkle Root 的哈希值等数据。此外，区块体的数据记录通过Merkle Tree 的哈希过程生成唯一的Merkle Root 记录于区块头。

### 区块体

记录一定时间内所生成的详细数据，包括当前区块经过验证的、区块创建过程中生成的所有交易记录或是其他信息，可以理解为账本的一种表现形式。

### 哈希值/ 散列值

哈希值通常用一个短的随机字母和数字组成的字符串来代表，是一组任意长度的输入信息通过哈希算法得到的“数据指纹”。因为计算机在底层机器码是采用二进制的模式，因此通过哈希算法得到的任意长度的二进制值映射为较短的固定长度的二进制值，即哈希值。此外，哈希值是一段数据唯一且极其紧凑的数值表示形式，如果通过哈希一段明文得到哈希值，哪怕只更改该段明文中的任意一个字母，随后得到的哈希值都将不同。

### 时间戳

时间戳从区块生成的那一刻起就存在于区块之中，用于标识交易时间的字符序列，具备唯一性，用来记录并表明存在的、完整的、可验证的数据，是每一次交易记录的认证。

### 随机数/ 一次性的随机数/Nonce

Nonce 是指“只使用一次的随机数”，在挖矿中是一种用于挖掘加密货币的自动生成的、毫无意义的随机数，在解决数学难题的问题中被使用一次之后，如果不能解决该难题则该随机数就会被拒绝，而一个新的Nonce 也会被测试出来并且直到问题解决，当问题解决时矿工就会得到加密货币作为奖励。在区块结构中，Nonce 是基于工作量证明所设计的随机数字，通过难度调整来增加或减少其计算时间；在信息安全中，Nonce 是一个
在加密通信只能使用一次的数字；在认证协议中，Nonce 是一个随机或伪随机数，以避免重放攻击。

## 3、共识机制

### 共识机制/ Consensus

由于点对点网络下存在较高的网络延迟，各个节点所观察到的事务先后顺序不可能完全一致。因此区块链系统需要设计一种机制对在差不多时间内发生的事务的先后顺序进行共识，这种对一个时间窗口内的事务的先后顺序达成共识的算法被称为“共识机制”。

### 工作量证明/Proof of Work/PoW

工作量证明简单理解就是一份证明，用来确认节点做过一定量的工作。监测工作的整个过程通常是极为低效的，而通过对工作的结果进行认证来证明完成了相应的工作量，则是一种非常高效的方式。比特币在区块的生成过程中使用了PoW 机制，<u>要得到合理的随机数求解数学难题需要经过大量尝试计算，通过查看记录和验证区块链信息的证明，就能知道是否完成了指定难度系数的工作量</u>.

### 权益证明/ Proof of Stake / PoS

PoS 也称**权益证明机制**，类似于把资产存在银行里，银行会通过你持有数字资产的数量和时间给你分配相应的收益。采用PoS 机制的加密货币资产，系统会根据节点的<u>持币数量和时间的乘积（币天数）</u>给节点分配相应的权益。

### 权益授权证明/ Delegated Proof of Stake / DPoS

DPoS 是一种<u>类似董事会的授权共识机制</u>，该机制让每一个持币人对整个系统的节点进行投票，决定哪些节点可以被信任并代理他们进行验证和记账，同时生成少量的对应奖励。DPoS 大幅提高区块链的处理能力，并降低区块链的维护成本，从而使交易速度接近于中心化的结算系统。

### 燃烧证明/ Proof of Burn / PoB

燃烧证明是一种投资于全新的加密货币的方法：为了获得一种新的货币，你必须“烧掉”（摧毁）另一种货币，比如比特币。从理论上讲，这将使每一种新的加密货币价值相当于被摧毁的币的价值，但实际上你不能真的摧毁加密货币，系统需要你把它送到一个会减少它的总供应量的地方。

### 51% 攻击/ 51% attack

51% 攻击，是指利用比特币以算力作为竞争条件的特点，<u>凭借算力优势篡改或者撤销自己的付款交易</u>。如果有人掌握了50% 以上的算力，他能够比其他人更快地找到开采区块需要的那个随机数，因此他能够比其他人更快地创建区块。

### 双重支付/ 双重花费/ 双花/ Double Spending

双重支付是一个<u>故意的分叉</u>，是指具有大量计算能力的节点发送一个交易请求并购买资产，在收到资产后又做出另外一个交易将相同量的币发给自己。攻击者通过创造一个分叉区块，将原始交易及伪造交易放在该区块上并基于该分叉上开始挖矿。如果攻击者有超过50％的计算能力，双重花费最终可以在保证在任何区块深度上成功；如果低于50％则有部分可能性成功。

### 拜占庭将军问题/ Byzantine Generals Problem / BGP

拜占庭将军问题是指“在存在消息丢失的不可靠信道上试图通过消息传递的方式达到一致性是不可能的”。因此在系统中存在除了消息延迟或不可送达的故障以外的错误，包括消息被篡改、节点不按照协议进行处理等，将会潜在地会对系统造成针对性的破坏。

### 改进型实用拜占庭容错/ Practical Byzantine Fault Tolerance / PBFT

PBET 共识机制是<u>少数服从多数</u>，根据信息在分布式网络中节点间互相交换后各节点列出所有得到的信息，一个节点代表一票，选择大多数的结果作为解决办法。PBET 将容错量控制在全部节点数的1/3，<u>即如只要有超过2/3 的正常节点，整个系统便可正常运作</u>。

## 4、账户

### 账户/ Account

账户是在总账中的一份记录，通过地址在总账中索引，地址由公钥衍生而来，区公钥最后20字节。总账包含有关该账户的状态的完整的数据。在一个加密货币系统中，该数据则包含了加密货币余额、未完成的交易订单等情况。

#### 外部账户（EOA）

由私钥控制，是由用户实际控制的账户。

#### 合约账户

合约账户是一个包含合约代码的账户。

## 5、数据结构与存储

区块、交易等数据最终都是存储在Level DB数据库中。Level DB是一个键值对数据库，key一般与散列相关，value一般是存储内容的RLP（递归长度的前缀）编码。

以太坊采用MPT数作为数据组织形式，用来组织和管理用户的账户状态、交易信息等重要数据。

以太坊中有三个Level DB数据库，BlockDB（块头和交易）、StateDB（账户的状态数据）、ExtrasDB（收据信息和其他辅助信息）。

## 6、超级账本Fabric

是一个许可的区块链构架，提供模块化的构架。

Fabric是超级账本项目中的基础核心平台项目。

账本是最核心的结构。

交易执行的逻辑通过链码来承载。

整个网络运行中发生的事件可被应用访问。

权限管理负责整个过程中的访问控制。

账本和交易进一步依赖核心的区块链结构、数据库、共识机制等技术；链码则依赖容器、状态机等技术；权限管理利用了已有的PKI体系、数字证书、加解密算法等诸多安全技术。

底层由多个节点组成P2P网络，通过gRPC通道（高性能远程过程调用）进行交互，利用Gossip（分布式同步协议）协议进行同步。

逻辑上将节点角色解耦为背书和提交。



