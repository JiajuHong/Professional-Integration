# 1.5关系型数据库系统

## 1、数据库系统

### 数据库系统的组成

数据库系统（DBS）由计算机硬件、数据库（DB）、数据库管理系统（DBMS）及其开发工具、数据库应用系统、数据库用户组成。

#### 数据库（DB）

数据库(DataBase 简称 DB)就是信息的集合或者说数据库是由数据库管理系统管理的数据的集合。

#### 数据库管理系统（DBMS）

数据库管理系统(Database Management System 简称 DBMS)是一种操纵和管理数据库的大型软件，通常用于建立、使用和维护数据库。

常用的数据库软件：

1. 关系型数据库

   - 开源

     - MySQL

     - PostgreSQL

   - 闭源

     - Oracle

     - Microsoft SQL Server

     - Access

     - DB2

     - Visual FoxPro

2. 非关系型数据库

   - Redis(开源)
   - MongoDB(开源)
   - Hbase(开源)

#### 数据库应用系统

或叫数据库应用软件，凡是使用数据库技术管理数据的系统都是数据库应用系统（DBAS）。

#### 数据库管理员

数据库管理员(Database Administrator, 简称 DBA)负责全面管理和控制数据库系统。

#### 数据库用户

是数据库的使用者，主要是使用数据，并操作数据。

操纵数据的方式有两种：

- 使用系统提供的命令
- 使用开发好的应用程序



### 数据库系统的特点

1. 结构化（与文件系统的最本质区别）
2. 数据共享性高、冗余度低、易扩充
3. 数据的独立性高：物理独立性和逻辑独立性
4. 由DBMS统一管理和控制

## 2、数据模型

数据模型是对现实世界数据特征的抽象。目前主要使用的数据模型有两种：概念数据模型（概念模型）和结构数据模型（数据模型）

- 概念模型使用最广泛的是E-R图
- 结构数据模型是直接面向数据库的逻辑结构，主要有以下几种
  - 层次模型：树形结构
  - 网状模型：图形结构。一个结点可以有多个双亲结点和子节点
  - 关系模型：采用二维表
  - 面向对象模型：使用面向对象的方法。Oracle 8提供关系对象模型的数据结构描述。

数据模型是严格定义的一组概念的集合。数据模型的三要素是：静态特征（数据结构）、动态特征（数据操作）、数据约束条件。数据约束条件是一组完整性规则的集合。



## 3、关系数据模型

关系数据模型由关系数据结构、关系操作集合和关系完整性约束组成。

### 关系模型的数据结构

关系模型是建立在严格的数据概念基础上的。其数据结构是**二维表**。由行和列组成。

1. 关系：关系就是二维表

2. 元组：元组也叫记录。关系表中一行对应一个元组。组成元组的元素称为分量。实体或实体之间的联系均用一个元组表示。

3. 属性：一列就是一个属性（字段）。属性名也叫字段名。

4. 域：属性的取值范围

5. 分量：元组中的一个属性值。如“男”

6. 候选码：关系中唯一标识一个元组的某一属性或属性组。

7. 主码：从候选码中选一个作为主码，用来唯一标识一个元组。

8. 全码：关系模式的所有属性都是这个关系模式的候选码。

9. 主属性和非主属性：候选码中的属性是主属性。

10. 关系模式：是关系的描述。形式为：R(U,D,Dom,F)

    - F：关系名
    - U：组成该关系的属性集合
    - D：属性组U中的属性来自的域
    - Dom：属性向域的映像集合
    - F：属性间数据依赖关系的集合

    关系模式通常简记为R(U)或R(A1,A2,A3...,An)

    关系和关系模式：

    - 关系模式是二维表的静态结构，关系模式是静态的、稳定的。
    - 关系是关系模式在某一时刻的状态和内容。关系是动态的、随时间不断变化的。
    - 关系模式是型，关系是值，关系模式是对关系的描述，关系是关系模式的一个实例。

### 关系的性质

1. 同一属性的数据具有同质性。每一列中的分量是同一类型的数据，都来自同一个域。
2. 同一关系的属性名具有不可重复性。同一关系的不同属性的数据可以出自一个域，但是不同属性的属性名不能相同。
3. 关系中列的位置具有顺序无关性。列的次序可以任意交换和重新组织。
4. 关系具有元组无冗余性。关系任意两个元组不能完全相同。
5. 关系中元组的位置具有顺序无关性。元组的顺序可以任意交换。
6. 关系中每个分量必须是原子值。每个分量必须是不可分割的数据项。

### 关系操作集合

选择、投影、连接、查询；增加、删除、修改。

### 关系的完整性

关系的完整性规则是对关系的某种约束条件。关系模型允许定义三种完整性约束：实体完整性、参照完整性、用户自定义的完整性。

#### 实体完整性

关系中主属性的值不能为空，不仅仅是指主键不能为空。

1. 实体完整性是针对基本关系而言的。一个基本表对应信息世界中的一个实体集。
2. 信息世界中的实体是可以区分的，即他们具有某种唯一性标识。
3. 关系模型中以主码（主键）作为唯一性标识。
4. 主属性不能取空值。空值就是不知道或不确定的值。

#### 参照完整性

若属性或属性组F是基本关系R的外码，它与基本关系S的主码K<sub>s</sub>相对应（R和S有可能是同一关系），则R中的每个元组在F上的值必须为以下值：

1. 取空值（F的每个属性值均为空值）
2. 等于S中的某个元组的主码值

#### 用户自定义的完整性

针对某一具体关系的约束条件。例如某个属性的取值范围在0~100；性别只能取“男”或“女”等。

### 关系运算

#### 关系代数

关系代数三大要素：运算对象（关系）、运算符、运算结果（关系）。

关系运算符有4类：集合运算符、专门的关系运算符、比较运算符、逻辑运算符

![image-20221106221003708](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221106221003708.png)

关系代数运算按运算符不同可分为传统集合运算和专门的关系运算。

### 传统集合运算

传统集合运算是二目运算，包括并、交、差、广义笛卡尔积。

#### 并（Union）

关系R和S具有相同的目n（两个关系都有n个属性）。

关系R与关系S的并记作：`R∪S=｛t│t∈R∨t∈S｝`，t是元组变量。

结果仍为n目关系。

#### 差（Difference）

`R-S=｛t│t∈R∧t∉S｝`

结果关系仍为n目关系，由属于R而不属于S的元组组成。

#### 交（**Intersection**）

`R⋂S=｛t│t∈R∧t∈S｝`。

结果关系仍为n目关系，由既属于R又属于S的元组组成。

交可以用差来表示：`R⋂S=R-(R-S)`

#### 广义笛卡尔积

两个分别为n和m目的关系R和S的广义笛卡尔积是一个（n+m）列的元组的集合。元组的前n列是R的一个元组，后m列是S的一个元组。若R有k1个元组，S有k2个元组，则关系R和关系S的广义笛卡儿积有k1×k2个元组。

R×S={t<sub>r</sub>t<sub>s</sub>|t<sub>r</sub>∈R∧t<sub>s</sub>∈S}

### 专门的关系运算

#### 选择

在关系R中选择满足给定条件的诸元组。

σF(*R*)={*t*|*t*∈*R*∧*F*(*t*)='真'}。F表示选择条件，是一个逻辑表达式，取值为“真”或“假”。

选择运算实质是从关系R中选择条件F为真的元组，是从行的角度进行运算。

对应select语句中的where字句。

#### 投影

关系R上的投影是从R中选择出若干属性列组成新的列。

`πA(R)={t[A]|t∈R}`。

对应select语句中要查询的字段。

#### 连接

从两个关系的笛卡尔积中选取属性间满足一定条件的元组。

![image-20221105130740148](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105130740148.png)

θ是比较运算符。连接运算是从R和S的笛卡尔积R×S中选取R在A属性上的值与S在B属性上的值满足比较关系的元组。

连接运算有两种重要的连接：等值连接和自然连接。

##### 等值连接

θ为“=”的连接运算称为等值连接。从R和S的笛卡尔积中选取A、B属性值相等的元组。

![image-20221105131205525](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105131205525.png)

##### 自然连接

是一种特殊的等值连接，要求两个关系中进行比较的分量必须是相同的属性组，并在结果中把重复的属性列去掉。

![image-20221105131357916](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105131357916.png)

#### 除

## 4、数据库系统的体系结构

### 三级模式和两级映像

数据库系统的体系结构分为三级模式和两级映像。

![image-20221105132454314](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105132454314.png)

三级模式是数据的3个抽象级别，分为模式、外模式、内模式。DBMS在三级模式结构之间提供了两级映像：外模式/模式映像，模式/内模式映像。两级映像保证了数据库系统中的逻辑独立性和物理独立性。

1. 模式

   模式也叫概念模式或逻辑模式。是对数据库中全部数据的逻辑结构和特征的描述。一个数据库只有一个模式。

2. 外模式

   外模式也称子模式或用户模式。它是对数据库用户（包括程序员和最终用户）能够看见和使用的局部数据的逻辑结构和特征的描述，即个别用户涉及的数据的逻辑结构。

   **外模式通常是模式的子集，一个数据库可以有多个外模式。**

   **外模式是保证数据库安全性的一个有效措施，每个用户只能看见或访问所对应的外模式中的数据，数据库中的其余数据是不可见的。**

3. 内模式

   内模式也称存储模式或物理模式。**一个数据库只有一个内模式**。内模式是对数据物理结构和存储方式的描述，是数据在数据库内部的表示方式。

   内模式的设计目标是将系统的模式（全局逻辑结构）组织成最优的物理模式，以提高数据的存取效率，改善系统的性能指标。

   数据库管理系统提供内模式描述语言（内模式DDL）来定义外模式。

4. 外模式/模式映像

   模式描述的是数据的全局逻辑结构，**外模式描述的是数据的局部逻辑结构**，对应于同一个模式可以有任意多个外模式。**对于每个外模式，数据库系统都有一个外模式/模式映像**，它定义了该外模式与模式之间的对应关系。这些映像定义通常包含在各自外模式的描述中。

5. 模式/内模式映像

   数据库中只有一个模式，也只有一个内模式，所以**模式/内模式映像是唯一的**，它定义了数据库**全局逻辑结构与存储结构之间的对应关系**。例如，说明逻辑记录和字段在内部是如何表示的。该映像定义通常包含在模式描述中。

6. 两级数据独立性

   **数据独立性（Data Independence）是指应用程序和数据库的数据结构之间相互独立，不受影响。**

   1. 逻辑数据独立性

      当模式改变时（如增加新的关系、新的属性、改变属性的数据类型等），由数据库管理员对各个**外模式/模式映像**作相应改变，可以使**外模式保持不变**。应用程序是依据数据的外模式编写的，因而**应用程序不必修改**，保证了数据与程序的**逻辑独立性**，简称逻辑数据独立性。

   2. 物理数据独立性

      当数据库的存储结构改变了（如选用了另一种存储结构），由数据库管理员对**模式/内模式映像**作相应改变，可以保证**模式保持不变**，因而**应用程序也不必改变**。保证了数据与程序的**物理独立性**，简称物理数据独立性。



## 5、关系数据库语言SQL

**结构化查询语言**（Structured Query Language，SQL）是由美国国家标准协会（American National Standards Institute，ANSI）和国际标准化组织（International Standards Organization，ISO）定义的标准。

### SQL的特点

（1）一体化：集数据定义语言、数据操纵语言、数据控制语言元素为一体。

（2）使用方式：有两种使用方式，即**交互使用方式**和**嵌入到高级语言**中的使用方式。

（3）**非过程化**语言：只需要提出“干什么”，不需要指出“如何干”，语句的操作过程由系统自动完成。

（4）人性化：符合人们的思维方式，容易理解和掌握

### SQL的分类

1. 数据定义语言DDL

   create(创建数据库、表、视图、索引)、alter(修改表或数据库结构)、drop(删除数据库、表或索引、视图)、truncate(清空表数据)

2. 数据查询语言DQL

   由select字句、from字句、where字句组成的查询块。

3. 数据操纵语言DML

   select(查询)、insert(插入)、update(更新)、delete(删除)

4. 数据控制语言DCL

   grant(赋予用户权限)、revoke(收回权限)、deny(禁止权限)

5. 事务控制语言TCL

   savepoint(设置保存点)、rollback(回滚)、commit(提交)

![image-20221105135715350](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105135715350.png)

## 6、事务

### 何谓事务？

我们设想一个场景，这个场景中我们需要插入多条相关联的数据到数据库，不幸的是，这个过程可能会遇到下面这些问题：

- 数据库中途突然因为某些原因挂掉了。
- 客户端突然因为网络原因连接不上数据库了。
- 并发访问数据库时，多个线程同时写入数据库，覆盖了彼此的更改。
- ......

上面的任何一个问题都可能会导致数据的不一致性。为了保证数据的一致性，系统必须能够处理这些问题。事务就是我们抽象出来简化这些问题的首选机制。事务的概念起源于数据库，目前，已经成为一个比较广泛的概念。

**何为事务？** 一言蔽之，**事务是逻辑上的一组操作，要么都执行，要么都不执行。**

事务最经典也经常被拿出来说例子就是转账了。假如小明要给小红转账 1000 元，这个转账会涉及到两个关键操作，这两个操作必须都成功或者都失败。

1. 将小明的余额减少 1000 元
2. 将小红的余额增加 1000 元。

事务会把这两个操作就可以看成逻辑上的一个整体，这个整体包含的操作要么都成功，要么都要失败。这样就不会出现小明余额减少而小红的余额却并没有增加的情况。

![image-20221105135951275](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105135951275.png)

### 何谓数据库事务？

大多数情况下，我们在谈论事务的时候，如果没有特指**分布式事务**，往往指的就是**数据库事务**。

数据库事务在我们日常开发中接触的最多了。如果你的项目属于单体架构的话，你接触到的往往就是数据库事务了。

**那数据库事务有什么作用呢？**

简单来说，数据库事务可以保证多个对数据库的操作（也就是 SQL 语句）构成一个逻辑上的整体。构成这个逻辑上的整体的这些数据库操作遵循：**要么全部执行成功,要么全部不执行** 。

```sql
# 开启一个事务
START TRANSACTION;
# 多条 SQL 语句
SQL1,SQL2...
# 提交事务
COMMIT;
```

![image-20221105140221110](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105140221110.png)

另外，关系型数据库（例如：`MySQL`、`SQL Server`、`Oracle` 等）事务都有 **ACID** 特性：

![image-20221105140246063](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105140246063.png)

1. **原子性**（`Atomicity`） ： 事务是最小的执行单位，不允许分割。事务的原子性确保动作要么全部完成，要么完全不起作用；
2. **一致性**（`Consistency`）： 执行事务前后，数据保持一致，例如转账业务中，无论事务是否成功，转账者和收款人的总额应该是不变的；
3. **隔离性**（`Isolation`）： 并发访问数据库时，一个用户的事务不被其他事务所干扰，各并发事务之间数据库是独立的；
4. **持久性**（`Durabilily`）： 一个事务被提交之后。它对数据库中数据的改变是持久的，即使数据库发生故障也不应该对其有任何影响。

> **只有保证了事务的持久性、原子性、隔离性之后，一致性才能得到保障。也就是说 A、I、D 是手段，C 是目的！**

![image-20221105140410836](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105140410836.png)

## 7、视图

视图是一个**虚拟表**，其内容由查询定义。同真实的表一样，视图包含一系列带有名称的列和行数据。但是，视图并不在数据库中以存储的数据值集形式存在。行和列数据来自由定义视图的查询所引用的表，并且在引用视图时动态生成。

视图具有表结构文件，但**不存在数据文件。**

对其中所引用的基础表来说，视图的作用类似于筛选。定义视图的筛选可以来自当前或其它数据库的一个或多个表，或者其它视图。通过视图进行查询没有任何限制，通过它们进行数据修改时的限制也很少。

视图是存储在数据库中的查询的sql语句，它主要出于两种原因：安全原因，视图可以隐藏一些数据，如：社会保险基金表，可以用视图只显示姓名，地址，而不显示社会保险号和工资数等，另一原因是可使复杂的查询易于理解和使用。

## 8、数据字典

数据字典是数据库中所有对象及其关系的信息集合。

数据字典最重要的作用是作为分析阶段的工具。

数据字典是数据库的重要组成部分，它存放有数据库所用的有关信息，对用户来说是一组只读的表。



## 9、数据库设计

### 1、需求分析

对应软件项目中的可行性分析和项目开发计划。

### 2、概念结构设计

对应软件项目中的需求分析。

对用户的需求进行综合、归纳、抽象，形成一个独立于DBMS的概念模型。

概念结构设计的方法通常有以下4种：

1. 自顶向下：首先定义全局概念结构模型，然后逐步细化。
2. 自底向上：首先定义各局部应用的概念结构，在将他们集成起来，得到全局概念结构。
3. 逐步扩张：首先定义最重要的核心概念结构，然后向外扩充，以滚雪球的方式逐步生成其他概念结构，直至总体概念结构。
4. 混合策略：将自顶向下和自底向上的方法相结合，用自顶向下的策略设计一个全局概念结构的框架，以它为框架自底向上设计各局部概念结构。

最常用的策略是混合策略。

![image-20221105141746851](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105141746851.png)

#### 概念结构设计的步骤

1. 进行数据抽象，设计局部E-R模型。
2. 集成各局部E-R模型，形成全局E-R模型。

![image-20221105141846934](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105141846934.png)

E-R图也称实体-联系图，提供表示实体类型、属性和联系的方法。

1. 用矩形框表示实体型，在框内写上实体名。

2. 用椭圆形框表示实体的属性，并用无向边把实体和属性连接起来。

3. 用菱形框表示实体间的联系，在菱形框内写上联系名，并用无向边分别把菱形框与有关实体连接起来，在无向边旁边注明联系的类型。如果实体间的联系也有属性，则把属性和菱形框也用无向边连接起来。

   实体间的联系可分为三类：

   1. 一对一联系：1:1
   2. 一对多联系：1:n
   3. 多对多联系：m:n

   ![image-20221105142704215](https://xingqiu-tuchuang-1256524210.cos.ap-shanghai.myqcloud.com/13837/image-20221105142704215.png)

### 3、逻辑结构设计

对应软甲项目中的概要设计。

把概念结构设计阶段的E-R模型转换为某个具体的DBMS支持的数据模型。

#### 数据库三范式

**1NF(第一范式)**

属性（对应于表中的字段）不能再被分割，也就是这个字段只能是一个值，不能再分为多个其他的字段了。**1NF 是所有关系型数据库的最基本要求** ，也就是说关系型数据库中创建的表一定满足第一范式。

**2NF(第二范式)**

2NF 在 1NF 的基础之上，消除了非主属性对于码的部分函数依赖，即非主属性完全函数依赖于码（一个或多个）。

解决不满足第二范式的方法是用投影分解把关系模式分解为多个关系模式。

一些重要的概念：

- **函数依赖（functional dependency）** ：若在一张表中，在属性（或属性组）X 的值确定的情况下，必定能确定属性 Y 的值，那么就可以说 Y 函数依赖于 X，写作 X → Y。
- **部分函数依赖（partial functional dependency）** ：如果 X→Y，并且存在 X 的一个真子集 X0，使得 X0→Y，则称 Y 对 X 部分函数依赖。比如学生基本信息表 R 中（学号，身份证号，姓名）当然学号属性取值是唯一的，在 R 关系中，（学号，身份证号）->（姓名），（学号）->（姓名），（身份证号）->（姓名）；所以姓名部分函数依赖与（学号，身份证号）；
- **完全函数依赖(Full functional dependency)** ：在一个关系中，若某个非主属性数据项依赖于全部关键字称之为完全函数依赖。比如学生基本信息表 R（学号，班级，姓名）假设不同的班级学号有相同的，班级内学号不能相同，在 R 关系中，（学号，班级）->（姓名），但是（学号）->(姓名)不成立，（班级）->(姓名)不成立，所以姓名完全函数依赖与（学号，班级）；
- **传递函数依赖** ： 在关系模式 R(U)中，设 X，Y，Z 是 U 的不同的属性子集，如果 X 确定 Y、Y 确定 Z，且有 X 不包含 Y，Y 不确定 X，（X∪Y）∩Z=空集合，则称 Z 传递函数依赖(transitive functional dependency) 于 X。传递函数依赖会导致数据冗余和异常。传递函数依赖的 Y 和 Z 子集往往同属于某一个事物，因此可将其合并放到一个表中。比如在关系 R(学号 , 姓名, 系名，系主任)中，学号 → 系名，系名 → 系主任，所以存在非主属性系主任对于学号的传递函数依赖。。

**3NF(第三范式)**

3NF 在 2NF 的基础之上，消除了非主属性对于码的传递函数依赖 。符合 3NF 要求的数据库设计，**基本**上解决了数据冗余过大，插入异常，修改异常，删除异常的问题。比如在关系 R(学号 , 姓名, 系名，系主任)中，学号 → 系名，系名 → 系主任，所以存在非主属性系主任对于学号的传递函数依赖，所以该表的设计，不符合 3NF 的要求。

### 4、物理结构设计

对应软件项目中的详细设计。

主要是为所设计的数据库选择合适的存储结构和存取路径。

### 5、数据库实施

对应软件项目中的编码和单元测试。

包括编程、测试和试运行

### 6、数据库的运行和维护

对应软件项目中的总和测试和软件维护。

系统的运行与数据库的日常维护。